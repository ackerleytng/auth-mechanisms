# CAS Notes

> OAuth terms are in all caps (in OAuth terminology) to distinguish the same
> word being used in different contexts in the two protocols

## Architecture

Client-server architecture, where client is the app that needs authentication/authorization, and server can be backed by LDAP, a database, or AD

### Components

+ Web (Spring MVC/Spring Webflow)
  + Just an interface through which clients communicate with CAS
+ Ticketing
  + Handles tickets for CAS client access
  + Begins with the issuance of a ticket-granting ticket on successful authentication
+ Authentication
  + Authenticates the user. Typically only processes requests at the start of an SSO session

## Definitions

### CAS Server

The server that authenticates users and grants access to CAS-enabled services

> The AUTHORIZATION SERVER in OAuth

### CAS Clients

Any CAS-enabled application/library that communicates with the server over a supported protocol

Supported protocols:

+ CAS (versions 1, 2, and 3)
+ SAML 1.1 and 2
+ OpenID Connect
+ OpenID
+ OAuth 2.0
+ Web Services Federation Language (WS Federation)

Official libraries:

+ .NET CAS Client
+ Java CAS Client
+ PHP CAS Client
+ Apache CAS Client (an apache plugin)

## CAS Entities

### Service Ticket (ST)

+ An opaque string that is used by the client to obtain access to a service.
+ Service ticket is obtained from CAS server upon a client's presentation of
  credentials and a service identifier to `/login`

> This ticket is like oauth's ACCESS TOKEN, in that it is a representation of
> the RESOURCE OWNER's authorization

> It is also like an AUTHORIZATION CODE in that it needs to be validated at the
> CAS Server before a session cookie can be set with the browser. OAuth does
> not specify how a USER-AGENT can have continued access to a PROTECTED
> RESOURCE through the CLIENT. One implementation is to have the ACCESS TOKEN
> held by the USER-AGENT after it is obtained by a CLIENT.

#### Properties

+ Only valid for the service identifier that was presented to `/login`
+ Must be valid only for one ticket validation attempt
  + Whether or not validation was successful, CAS server will invalidate the
    ticket
+ Tickets will expire soon after they are issued (recommended: 5 mins)
+ Tickets must be sufficiently random so they are not guessable (recommended:
  256 chars in length)

### Proxy Ticket (PT)

+ An opaque string that service uses as a credential to obtain access to a
  back-end service on behalf of a client
+ Obtained from CAS upon a service's presentation of a valid proxy-granting
  ticket, and a service identifier for the back-end service to which it is
  connecting
+ Properties: similar to service ticket

> This ticket is also like OAuth's AUTHORIZATION CODE. OAuth does not
> distinguish between an AUTHORIZATION CODE issued to a service or human user

### Proxy-Granting Ticket (PGT)

+ An opaque string that is used by a service to obtain proxy tickets

> This is a bit like an AUTHORIZATION GRANT, which in OAuth, can take the form
> of an AUTHORIZATION CODE. OAuth was designed to make granting permissions to
> OAuth clients explicit, so AUTHORIZATION CODEs are not meant to be reused

> TODO: Look into How OAuth can handle automated granting

#### Properties

+ May be used to obtain multiple proxy tickets
+ Must expire when client logs out of CAS server
+ Same recommended length and randomness requirements as PT and ST

### Proxy-Granting Ticket IOU (PGTIOU)

+ An opaque string that is placed in response to a request for a PT
+ Used to map a given PGT to a PGT request

### Login Ticket (LT)

+ Optional string that is
  + Provided by `/login` as a credential requestor
  + Checked by `/login` as a credential acceptor

> No analogue in OAuth since OAuth doesn't handle authentication, but this
> seems to serve as a CSRF token for logging in. OAuth does mention that the
> authorization server has to implement CSRF protection

### Ticket-Granting Cookie (TGC)

+ An HTTP cookie set by CAS upon establishment of a single sign-on session
+ This cookie maintains login state for the client and while it is valid, the
  client can present it to CAS in lieu of primary credentials

> No analogue in OAuth since OAuth doesn't handle authentication, but
> authorization servers in OAuth can implement a similar cookie mechanism with
> CSRF protection to achieve this same effect of automatically logging in on
> subsequent requests to the AUTHORIZATION SERVER

#### Properties

+ A TGC shall expire at the end of a client's browser session
+ CAS server shall set cookie path to be as restrictive as possible
+ Same recommended length and randomness requirements as PT and ST

### Ticket-Granting Ticket (TGT)

+ An opaque string that is generated by the CAS server and issued upon authentication
+ May be tied to the ticket-granting cookie
  + Has validity period, etc, tied to TGC

> A bit like a REFRESH TOKEN, but in OAuth a REFRESH TOKEN is never granted to
> a browser as a browser is considered a PUBLIC CLIENT which cannot protect its
> secrets.

> Since the TGT is supposed to expire together with the TGC, we can think of it
> as the same entity, perhaps separated for CAS to work without a cookie
> mechanism

#### Properties

+ May be used by services to obtain multiple service tickets, not one time use
+ Must expire when the client logs out of CAS
+ Same recommended length and randomness requirements as PT and ST
